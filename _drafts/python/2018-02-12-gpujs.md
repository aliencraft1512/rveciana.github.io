---
layout: post
title:  gpu.js
date:   2018-02-03
teaser: gpujs-mapping.png
categories: other
tags: [GPU, gpujs, canvas]
thumbnail: /images/other/gpujs-mapping/twitter.png
twitter-card: summary
description: Use the GPU to calculate and draw data layers
---

[gpu.js][1] is a JavaScript Acceleration library for [GPGPU (General purpose computing on GPUs)][2] in Javascript. This means, basically, using the GPU instead of the CPU for the calculations, and coding in simple JavaScript.

The library is awesome, but I found some issues trying to run my things, so I will try to put all my steps here, which will help me in first place.

Including the library
---------------------

From a regular web page, just include:

{% highlight js %}
<script src="/path/to/js/gpu.min.js"></script>
{% endhighlight %}

then, initialize the library calling

{% highlight js %}
const gpu = new GPU();
{% endhighlight %}

It's possible to pass to the GPU constructor the options:

    {mode: 'gpu'} or {mode: 'cpu'}

Setting it forces the use of the CPU, which can be nice for performance comparison.

Using node, just install it with:

    npm install gpu.js

And require the module with:



### ObservableHQ

[ObservableHQ][3] is a new and awesome site to publish interactive examples. Requiring libraries is possible, but they have to be in UMD or AMD, which is not the case of [gpu.js][1]. A working solution is using the [wzrd][4] service

{% highlight js %}
GPU = require('https://wzrd.in/standalone/gpu.js')
{% endhighlight %}

First working example
---------------------

Let's see the simplest calculation using node:

{% highlight js %}
var GPU = require("gpu.js");
var gpu = new GPU();

var gpuKernel = gpu.createKernel(function() {
    return (this.thread.x + this.thread.y);
}).setOutput([2,2]);

console.info(gpuKernel());
{% endhighlight %}

* After initializing the class, a kernel is created with *createKernel*
  * The function that calculates every point is passed as the parameter
  This function has the *this.thread.x, this.thread.y and this.thread.z* variables that return the position in the matrix to calculate
  * In the *setOutput* method, the size of the matrix is set
* Just call the created kernel to calculate the values

Some more things about this functions:

* They can take array arguments

  function(points){...}

and call it

  gpuKernel([1,2,3])

* The size of the matrix is not accessible, unless a constant is declared

{% highlight js %}
var gpuKernel = gpu.createKernel(function() {
    for(let i = 0; i <this.constants.xSize; i++){
      ....
    }
    return (this.thread.x + this.thread.y);
}).setOutput([2,2])
  .setConstants({xSize:2, ySize: 2});
{% endhighlight %}

* The JavaScript operators that can be called inside the kernel functions are quite limited. [Here's the list][6]. Also, no *console.log* and many other functions can go there.

Drawing directly on a Canvas
----------------------------

One of the points that make [gnu.js][1] really interesting is that the gpu function can draw directly on a Canvas element, which is what we need when mapping. Here's a simple example, to run directly on the browser:

{% highlight js %}
<!DOCTYPE html>
<meta charset="utf-8">
<body>
    <script src="gpu.min.js"></script>
<script>
const gpu = new GPU();
const render = gpu.createKernel(function() {
    this.color(this.thread.x/500, this.thread.y/500, 0.4, 1);
})
  .setOutput([500, 500])
  .setGraphical(true);

render();
const canvas = render.getCanvas();
document.getElementsByTagName('body')[0].appendChild(canvas);

</script>
{% endhighlight %}

* The method *setGraphical(true)* has to be called to make the kernel draw on a Canvas. The *setOutput* method will set now the Canvas size
* Later, get the Canvas with *getCanvas()*
* Inside the function, set the *this.color* field with four values (rgba) from 0 to 1
* The y axis goes bottom to top! This is the opposite of the usual notation

It's easy! The result:

<img src="{{ site.baseurl }}/images/other/gpujs-mapping/result1.png"/>



Links
-----

* [The gpu.js web site][1]
* [GPGPU Wikipedia page][2]
* [ObservableHQ][3]
* [wzrd.in][4]
* [generateMatrices source][5]
* [List of gpu.js supported math functions][6]

[1]: http://gpu.rocks
[2]: https://en.wikipedia.org/wiki/General-purpose_computing_on_graphics_processing_units
[3]: https://observablehq.com
[4]: https://wzrd.in/
[5]: https://hackernoon.com/introducing-gpu-js-gpu-accelerated-javascript-ba11a6069327
[6]: https://github.com/gpujs/gpu.js?utm_source=recordnotfound.com#supported-math-functions
